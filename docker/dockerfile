# syntax=docker/dockerfile:1
FROM ros:foxy

# 避免交互提示
ENV DEBIAN_FRONTEND=noninteractive

# 1. 安装编译 OpenCV 3.4.1 所需依赖（含 Qt5）
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
      build-essential cmake git wget unzip pkg-config \
      libjpeg-dev libpng-dev libtiff-dev \
      libopenexr-dev libwebp-dev libtheora-dev \
      libavcodec-dev libavformat-dev libswscale-dev \
      libv4l-dev libxvidcore-dev libx264-dev \
      libgtk-3-dev libatlas-base-dev gfortran \
      python3-dev python3-pip python3-setuptools python3-distutils python3-empy python3-numpy \
      qt5-default libqt5opengl5-dev \
    && rm -rf /var/lib/apt/lists/*

# 2. 下载并编译 OpenCV 3.4.1，关闭所有 Python 绑定
WORKDIR /opt
RUN wget -O opencv.zip https://github.com/opencv/opencv/archive/3.4.1.zip && \
    unzip opencv.zip && mv opencv-3.4.1 opencv && \
    mkdir -p opencv/build && cd opencv/build && \
    cmake \
        -D CMAKE_BUILD_TYPE=Release \
        -D CMAKE_INSTALL_PREFIX=/usr/local \
        -D BUILD_PYTHON_SUPPORT=OFF \
        -D BUILD_opencv_python2=OFF \
        -D BUILD_opencv_python3=OFF \
        -D BUILD_EXAMPLES=OFF \
        -D BUILD_TESTS=OFF \
        -D BUILD_PERF_TESTS=OFF \
        -D BUILD_opencv_ts=OFF \
        .. && \
    make -j"$(nproc)" && \
    make install && \
    ldconfig && \
    cd /opt && rm -rf opencv opencv.zip

# 3. 安装其余系统依赖（包括 cv_bridge、image_transport、Ceres、Boost 等）
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
      python3-rosdep \
      ros-foxy-vision-opencv \
      ros-foxy-image-transport \
      libeigen3-dev \
      libceres-dev \
      libboost-filesystem-dev \
      libboost-program-options-dev \
      libboost-system-dev \
      libboost-serialization-dev \
      libboost-thread-dev && \
    rm -rf /var/lib/apt/lists/*


# 4. 用 pip 安装 colcon 扩展
RUN pip3 install --no-cache-dir colcon-common-extensions

# 5. 初始化 rosdep（如果已初始化则不报错）
RUN rosdep init || true && rosdep update

# 6. 默认加载 ROS 2 环境
RUN echo "source /opt/ros/foxy/setup.bash" >> ~/.bashrc

CMD ["/bin/bash"]

